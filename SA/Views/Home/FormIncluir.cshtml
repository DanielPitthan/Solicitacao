@model SA.Models.Solicitacao
@{
    ViewBag.Title = "FormIncluir";
}

@section ScriptsHead{
    <script src="~/Content/Scripts/sa.js"></script>
}

@using (Html.BeginForm("Adicionar", "Home", FormMethod.Post))
{
    @Html.Partial("_FormSa")
   
}

@section Scripts{
    <script src="~/Content/Scripts/jquery-3.2.1.js"></script>
    <script src="~/Content/Scripts/jquery.validate.js"></script>
    <script src="~/Content/Scripts/jquery.validate.unobtrusive.js"></script>
    <script src="~/Content/Scripts/bootstrap.min.js"></script>  
    
    
    <script>

      var btAdiciona = document.getElementById("btincluir");

      btincluir.onclick =  function(){
        AdicionaArray();
        AtualizaGrid();
      }
    </script>

    <script>
        
        var urlprd = "@Url.Action("GetLista", "Produtos")";
        var produtodigita = document.getElementById("produto");

        produtodigita.onkeypress = function()
        {
            var listaProduto = document.getElementById("lstproduto");
            var listaHtml = "";

            //Verifica se a quantide digitada é maior que 2
            if (produtodigita.value.length > 2) {

                //Faz a consulta no server pela digitação
                $.ajax({
                    url: urlprd,
                    type: "POST",
                    data: { 'produtoDesci': produtodigita.value },
                    success: function (response) {

                        for (var i = 0; i < response.lista.length; i++) {
                            var texto = response.lista[i].Codigo + response.lista[i].Descricao.trim();
                            listaHtml += "<option value='" + texto + "'>";
                        }
                        listaProduto.outerHTML = ' <datalist id="lstproduto">' + listaHtml + "</datalist>";

                    },
                    error: function (response) {
                        console.log("Erro! Não encontrei o produto");
                    }
                })
            }
        }
    </script>

    <script>

        var urlest = "@Url.Action("GetEstoque", "Produtos")";
        var quant = document.getElementById("quantidade");
        var produtodigita = document.getElementById("produto");
        produtodigita.onblur = function () {

            //Busca a lista de produtos
            var listaProduto = document.getElementById("lstproduto");
            var codigoPrd = this.value.substring(0, 15);

            $.ajax({
                url: urlest,
                type: "POST",
                data: { "produtoCod": codigoPrd },
                success: function (response) {                    

                    
                    if (response.estoque <= 0) {
                        quant.className = "alert alert-danger form-control";
                        quant.placeholder = "Saldo Insuficiente: " + response.estoque;                        
                    } else {
                        quant.placeholder = "Saldo em Estoque: " + response.estoque;
                        quant.className = "form-control";
                    }
                    qtdestoque = response.estoque;

                    
                },
                error: function (response) {
                    console.log("Produto não localizado!");
                }
            })

        }
    </script>
     
}